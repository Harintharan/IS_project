<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Secure Chat</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <style>
        #chatBox {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            background-color: #f8f9fa;
        }
        #chatBox p {
            margin: 5px 0;
        }
    </style>
</head>
<body class="bg-light">

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>ðŸ‘‹ Welcome, <span th:text="${currentUser}"></span></h3>
        <form id="logoutForm" method="post" action="/logout">
            <input type="submit" value="ðŸšª Logout" class="btn btn-danger btn-sm"/>
        </form>
    </div>

    <div class="row">
        <!-- Online Users -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    ðŸŸ¢ Online Users
                </div>
                <ul class="list-group list-group-flush">
                    <li th:each="user : ${onlineUsers}" th:if="${user} != ${currentUser}" class="list-group-item">
                        <a href="#" th:attr="data-user=${user}" onclick="selectUser(this)" class="text-decoration-none">
                            <span th:text="${user}"></span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <!-- Chat Section -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    ðŸ’¬ Chat with: <span id="chattingWith" class="fw-bold">None</span>
                </div>
                <div class="card-body">
                    <div id="chatBox"></div>
                </div>
                <div class="card-footer">
                    <form id="chatForm" class="d-flex gap-2">
                        <input type="text" id="message" class="form-control" placeholder="Type a message..." required>
                        <button type="submit" class="btn btn-primary">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for chat functionality -->
<script th:inline="javascript">
    let selectedUser = null;
    const username = [[${#strings.escapeJavaScript(currentUser)}]];

    function selectUser(el) {
        selectedUser = el.getAttribute("data-user");
        document.getElementById("chattingWith").innerText = selectedUser;
        loadChat();
    }

    document.getElementById("chatForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const msg = document.getElementById("message").value;

        fetch('/chat/send', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sender: username, receiver: selectedUser, message: msg })
        }).then(() => {
            document.getElementById("message").value = "";
            loadChat();
        });
    });

    function loadChat() {
        if (!selectedUser) return;
        fetch(`/chat/history?user1=${username}&user2=${selectedUser}`)
            .then(res => res.json())
            .then(messages => {
                const chatBox = document.getElementById("chatBox");
                chatBox.innerHTML = "";
                messages.forEach(msg => {
                    const p = document.createElement("p");
                    p.innerText = msg;
                    chatBox.appendChild(p);
                });
            });
    }

    setInterval(loadChat, 3000);
</script>

</body>
</html>
